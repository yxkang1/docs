{"version":3,"file":"index.js","sources":["../../src/node/generate/getRedirectHTML.ts","../../src/cli/index.ts"],"sourcesContent":["export const getRedirectHTML = (redirectUrl: string): string => `<!doctype html>\n<html lang=\"en\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"robots\" content=\"noindex\">\n  <meta http-equiv=\"refresh\" content=\"0; url=${redirectUrl}\">\n  <link rel=\"canonical\" href=\"${redirectUrl}\">\n  <title>Redirecting...</title>\n  <script>\n    const anchor = window.location.hash.substring(1);\n    location.href = \\`${redirectUrl}\\${anchor? \\`#\\${anchor}\\`: \"\"}\\`;\n  </script>\n</head>\n<body>\n  <p>Redirecting...</p>\n</body>\n</html>\n`\n","#!/usr/bin/env node\nimport { createRequire } from 'node:module'\nimport { removeEndingSlash, removeLeadingSlash } from '@vuepress/helper'\nimport { cac } from 'cac'\nimport {\n  loadUserConfig,\n  resolveAppConfig,\n  resolveCliAppConfig,\n  resolveUserConfigConventionalPath,\n  resolveUserConfigPath,\n  transformUserConfigToPlugin,\n} from 'vuepress/cli'\nimport { createBuildApp } from 'vuepress/core'\nimport { fs, logger, path } from 'vuepress/utils'\nimport { getRedirectHTML } from '../node/generate/getRedirectHTML.js'\n\ninterface RedirectCommandOptions {\n  hostname: string\n  output?: string\n  config?: string\n  cache: string\n  temp?: string\n  cleanCache?: boolean\n  cleanTemp?: boolean\n}\n\nconst require = createRequire(import.meta.url)\n\nconst cli = cac('vp-redirect')\nconst { version } = require('@vuepress/plugin-redirect/package.json') as {\n  version: string\n}\n\ncli\n  .command(\n    'generate [source-dir]',\n    'Generate redirect site using VuePress project under source folder',\n  )\n  .option(\n    '--hostname <hostname>',\n    'Hostname to redirect to (E.g.: https://new.example.com/)',\n    { default: '/' },\n  )\n  .option('-c, --config <config>', 'Set path to config file')\n  .option(\n    '-o, --output <output>',\n    'Set the output directory (default: .vuepress/redirect)',\n  )\n  .option('--cache <cache>', 'Set the directory of the cache files')\n  .option('-t, --temp <temp>', 'Set the directory of the temporary files')\n  .option('--clean-cache', 'Clean the cache files before generation')\n  .option('--clean-temp', 'Clean the temporary files before generation')\n  .action(async (sourceDir: string, commandOptions: RedirectCommandOptions) => {\n    if (!sourceDir) {\n      cli.outputHelp()\n      return\n    }\n\n    // ensure NODE_ENV is set\n    process.env.NODE_ENV ??= 'production'\n\n    // resolve app config from cli options\n    const cliAppConfig = resolveCliAppConfig(sourceDir, {})\n\n    // resolve user config file\n    const userConfigPath = commandOptions.config\n      ? resolveUserConfigPath(commandOptions.config)\n      : resolveUserConfigConventionalPath(cliAppConfig.source)\n\n    const { userConfig } = await loadUserConfig(userConfigPath)\n\n    // resolve the final app config to use\n    const appConfig = resolveAppConfig({\n      defaultAppConfig: {},\n      cliAppConfig,\n      userConfig,\n    })\n\n    if (appConfig === null) return\n\n    // create vuepress app\n    const app = createBuildApp(appConfig)\n\n    // use user-config plugin\n    app.use(transformUserConfigToPlugin(userConfig, cliAppConfig.source))\n\n    // clean temp and cache\n    if (commandOptions.cleanTemp === true) {\n      logger.info('Cleaning temp...')\n      await fs.remove(app.dir.temp())\n    }\n    if (commandOptions.cleanCache === true) {\n      logger.info('Cleaning cache...')\n      await fs.remove(app.dir.cache())\n    }\n\n    const outputFolder = commandOptions.output\n      ? path.join(process.cwd(), commandOptions.output)\n      : path.join(app.dir.source(), '.vuepress', 'redirect')\n\n    // empty output directory\n    await fs.emptyDir(outputFolder)\n\n    // initialize vuepress app to get pages\n    logger.info('Initializing VuePress and preparing data...')\n\n    // initialize vuepress app to get pages\n    await app.init()\n\n    logger.info('Generating redirect pages...')\n\n    // redirect all pages\n    await Promise.all(\n      app.pages.map((page) => {\n        const redirectUrl = `${removeEndingSlash(commandOptions.hostname)}${\n          app.options.base\n        }${removeLeadingSlash(page.path)}`\n        const destLocation = path.join(\n          outputFolder,\n          removeLeadingSlash(page.path.replace(/\\/$/, '/index.html')),\n        )\n\n        return fs\n          .ensureDir(path.dirname(destLocation))\n          .then(() => fs.writeFile(destLocation, getRedirectHTML(redirectUrl)))\n      }),\n    )\n  })\n\ncli.command('').action(() => {\n  cli.outputHelp()\n})\n\ncli.help()\ncli.version(version)\n\ncli.parse()\n"],"names":["getRedirectHTML","redirectUrl","require","createRequire","cli","cac","version","sourceDir","commandOptions","cliAppConfig","resolveCliAppConfig","userConfigPath","resolveUserConfigPath","resolveUserConfigConventionalPath","userConfig","loadUserConfig","appConfig","resolveAppConfig","app","createBuildApp","transformUserConfigToPlugin","logger","fs","outputFolder","path","page","removeEndingSlash","removeLeadingSlash","destLocation"],"mappings":";4bAAO,MAAMA,EAAmBC,GAAgC;AAAA;AAAA;AAAA;AAAA;AAAA,+CAKjBA,CAAW;AAAA,gCAC1BA,CAAW;AAAA;AAAA;AAAA;AAAA,wBAInBA,CAAW;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,ECgB7BC,EAAUC,EAAc,YAAY,GAAG,EAEvCC,EAAMC,EAAI,aAAa,EACvB,CAAE,QAAAC,CAAQ,EAAIJ,EAAQ,wCAAwC,EAIpEE,EACG,QACC,wBACA,mEACF,EACC,OACC,wBACA,2DACA,CAAE,QAAS,GAAI,CACjB,EACC,OAAO,wBAAyB,yBAAyB,EACzD,OACC,wBACA,wDACF,EACC,OAAO,kBAAmB,sCAAsC,EAChE,OAAO,oBAAqB,0CAA0C,EACtE,OAAO,gBAAiB,yCAAyC,EACjE,OAAO,eAAgB,6CAA6C,EACpE,OAAO,MAAOG,EAAmBC,IAA2C,CAC3E,GAAI,CAACD,EAAW,CACdH,EAAI,WACJ,EAAA,MACF,CAGA,QAAQ,IAAI,WAAa,aAGzB,MAAMK,EAAeC,EAAoBH,EAAW,CAAA,CAAE,EAGhDI,EAAiBH,EAAe,OAClCI,EAAsBJ,EAAe,MAAM,EAC3CK,EAAkCJ,EAAa,MAAM,EAEnD,CAAE,WAAAK,CAAW,EAAI,MAAMC,EAAeJ,CAAc,EAGpDK,EAAYC,EAAiB,CACjC,iBAAkB,CAAA,EAClB,aAAAR,EACA,WAAAK,CACF,CAAC,EAED,GAAIE,IAAc,KAAM,OAGxB,MAAME,EAAMC,EAAeH,CAAS,EAGpCE,EAAI,IAAIE,EAA4BN,EAAYL,EAAa,MAAM,CAAC,EAGhED,EAAe,YAAc,KAC/Ba,EAAO,KAAK,kBAAkB,EAC9B,MAAMC,EAAG,OAAOJ,EAAI,IAAI,KAAK,CAAC,GAE5BV,EAAe,aAAe,KAChCa,EAAO,KAAK,mBAAmB,EAC/B,MAAMC,EAAG,OAAOJ,EAAI,IAAI,MAAO,CAAA,GAGjC,MAAMK,EAAef,EAAe,OAChCgB,EAAK,KAAK,QAAQ,IAAI,EAAGhB,EAAe,MAAM,EAC9CgB,EAAK,KAAKN,EAAI,IAAI,SAAU,YAAa,UAAU,EAGvD,MAAMI,EAAG,SAASC,CAAY,EAG9BF,EAAO,KAAK,6CAA6C,EAGzD,MAAMH,EAAI,KAAK,EAEfG,EAAO,KAAK,8BAA8B,EAG1C,MAAM,QAAQ,IACZH,EAAI,MAAM,IAAKO,GAAS,CACtB,MAAMxB,EAAc,GAAGyB,EAAkBlB,EAAe,QAAQ,CAAC,GAC/DU,EAAI,QAAQ,IACd,GAAGS,EAAmBF,EAAK,IAAI,CAAC,GAC1BG,EAAeJ,EAAK,KACxBD,EACAI,EAAmBF,EAAK,KAAK,QAAQ,MAAO,aAAa,CAAC,CAC5D,EAEA,OAAOH,EACJ,UAAUE,EAAK,QAAQI,CAAY,CAAC,EACpC,KAAK,IAAMN,EAAG,UAAUM,EAAc5B,EAAgBC,CAAW,CAAC,CAAC,CACxE,CAAC,CACH,CACF,CAAC,EAEHG,EAAI,QAAQ,EAAE,EAAE,OAAO,IAAM,CAC3BA,EAAI,WACN,CAAA,CAAC,EAEDA,EAAI,KACJA,EAAAA,EAAI,QAAQE,CAAO,EAEnBF,EAAI,MAAM"}