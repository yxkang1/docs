import{resolveWhitespacePosition as H,lineNumbers as P,collapsedLines as T}from"@vuepress/highlighter-helper";import{isPlainObject as x}from"vuepress/shared";import{Logger as C,getRealPath as p}from"@vuepress/helper";import{customAlphabet as j}from"nanoid";import{transformerNotationDiff as M,transformerNotationFocus as F,transformerNotationHighlight as D,transformerNotationErrorLevel as O,transformerNotationWordHighlight as R,transformerMetaWordHighlight as S,transformerRenderWhitespace as q,transformerCompactLineOptions as _}from"@shikijs/transformers";import{bundledLanguages as G,isSpecialLang as I,createHighlighter as U}from"shiki";import{bundledLanguages as we}from"shiki";import{colors as v}from"vuepress/utils";const L=Object.keys(G),z=/\[\\!code/g,B={name:"vuepress:add-class",pre(e){this.addClassToHast(e,"vp-code")}},J={name:"vuepress:cleanup",pre(e){delete e.properties.tabindex}},K={name:"vuepress:remove-escape",postprocess(e){return e.replace(z,"[!code")}},Q={name:"vuepress:empty-line",code(e){e.children.forEach(s=>{s.type==="element"&&s.tagName==="span"&&Array.isArray(s.properties.class)&&s.properties.class.includes("line")&&s.children.length===0&&s.children.push({type:"element",tagName:"wbr",properties:{},children:[]})})}},V=e=>{const s=[];return e.notationDiff&&s.push(M()),e.notationFocus&&s.push(F({classActiveLine:"has-focus",classActivePre:"has-focused-lines"})),e.notationHighlight&&s.push(D()),e.notationErrorLevel&&s.push(O()),e.notationWordHighlight&&(s.push(R()),s.push(S())),s.push(B,J,K,Q),s},X=(e,s=!1)=>{const t=H(e,s);return t===!1?[]:[q({position:t})]},Y=/-vue$/,y="@vuepress/plugin-shiki",b=new C(y),Z=j("abcdefghijklmnopqrstuvwxyz",10),w=e=>e.match(/^([^ :[{]+)/)?.[1]?.replace(Y,"").toLowerCase()??"",ee=(e,s)=>{const t=`\\b${s}\\s*=\\s*(?<quote>['"])(?<content>.+?)\\k<quote>(\\s|$)`,r=new RegExp(t,"i");return e.match(r)?.groups?.content??null},se=e=>{const s=e.replace(/^(?:\[.*?\])?.*?([\d,-]+).*/,"$1").trim(),t=[];return s?(s.split(",").map(r=>r.split("-").map(n=>parseInt(n,10))).forEach(([r,n])=>{r&&n?t.push(...Array.from({length:n-r+1},(i,o)=>r+o)):t.push(r)}),t.map(r=>({line:r,classes:["highlighted"]}))):[]},te=e=>{const s={},t=e.render.bind(e);return e.render=(r,n)=>(s.path=n.filePathRelative,t(r,n)),()=>s.path||"dynamic pages"},k=new Set,re=(e,s,t,r,n)=>{let i=w(e);return i&&!s.includes(i)&&!I(i)&&(r!=="silent"&&!k.has(i)&&(b.warn(`Missing ${v.cyan(e)} highlighter, ${t?`use ${v.cyan(t)} to highlight instead.`:"skip highlighting"}`),k.add(i)),r==="debug"&&b.info(`Unknown language ${v.cyan(i)} found in ${v.cyan(n())}`),i=t||"plain"),i},ne=/\{\{[^]*?\}\}/g,ie=(e,s)=>e.replace(ne,t=>{let r=s.get(t);return r||(r=Z(),s.set(t,r)),r}),oe=(e,s)=>{let t=e;return s.forEach((r,n)=>{t=t.replaceAll(r,n)}),t},ae=(e,s)=>{const t=new Map;return oe(s(ie(e,t).trimEnd()),t)},le=async(e,s,{langs:t=L,langAlias:r={},defaultLang:n,transformers:i=[],...o}={})=>{const l=o.logLevel??(s.env.isDebug?"debug":"warn"),c=l==="debug"?te(e):null,g=await U({langs:t,langAlias:r,themes:"themes"in o?Object.values(o.themes):[o.theme??"nord"]});await o.shikiSetup?.(g);const a=V(o),u=g.getLoadedLanguages();e.options.highlight=(m,d,f)=>ae(m,$=>g.codeToHtml($,{lang:re(d,u,n,l,c),meta:{__raw:f},transformers:[...a,...o.highlightLines??!0?[_(se(f))]:[],...X(f,o.whitespace),...i],..."themes"in o?{themes:o.themes,defaultColor:!1}:{theme:o.theme??"nord"}}))},N=/{([\d,-]+)}/,pe=e=>{const s=e.renderer.rules.fence;e.renderer.rules.fence=(...t)=>{const[r,n]=t,i=r[n],o=i.info||"",l=o.match(N);if(!l)return s(...t);i.info=o.replace(N,"").trim();const c=l[1];return i.info+=` ${c}`,s(...t)}},he=/<pre([\s\S]*?)style="([^"]*)"([^>]*)>/,ce=(e,{preWrapper:s=!0}={})=>{const t=e.renderer.rules.fence;e.renderer.rules.fence=(...r)=>{let n=t(...r);if(!n.startsWith("<pre"))return n;const[i,o,l]=r,c=i[o],g=c.info?e.utils.unescapeAll(c.info).trim():"",a=w(g),u=`${l.langPrefix}${a}`;if(!s)return n=n.replace(/<code[^]*?>/,"<code>"),n=`<pre class="${u}"${n.slice(4)}`,n;const m=ee(g,"title")||a;let d="";return n=n.replace(he,(f,$,W,E)=>(d=W.trim(),`<pre ${$.trim()}${E.trimEnd()}>`)),`<div class="${u}" data-highlighter="shiki" data-ext="${a}" data-title="${m}" style="${d}">${n}</div>`}},{url:h}=import.meta,ge=(e,{lineNumbers:s=!0,highlightLines:t=!0,collapsedLines:r="disable",notationDiff:n,notationErrorLevel:i,notationFocus:o,notationHighlight:l,notationWordHighlight:c,whitespace:g})=>{const a=[`import "${p("@vuepress/highlighter-helper/styles/base.css",h)}"`,`import "${p(`${y}/styles/shiki.css`,import.meta.url)}"`],u=[];s!=="disable"&&a.push(`import "${p("@vuepress/highlighter-helper/styles/line-numbers.css",h)}"`),(t||l)&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",h)}"`),n&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-diff.css",h)}"`),i&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-error-level.css",h)}"`),o&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-focus.css",h)}"`),l&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-highlight.css",h)}"`),c&&a.push(`import "${p("@vuepress/highlighter-helper/styles/notation-word-highlight.css",h)}"`),g&&a.push(`import "${p("@vuepress/highlighter-helper/styles/whitespace.css",h)}"`),r!=="disable"&&(a.push(`import "${p("@vuepress/highlighter-helper/styles/collapsed-lines.css",h)}"`,`import { setupCollapsedLines } from "${p("@vuepress/highlighter-helper/composables/collapsedLines.js",h)}"`),u.push("setupCollapsedLines()"));let m=a.join(`
`);return u.length&&(m+=`

export default {
  setup() {
    ${u.join(`
    `)}
  }
}
`),e.writeTemp("shiki/config.js",m)},A=(e={})=>{const s={preWrapper:!0,lineNumbers:!0,collapsedLines:"disable",...e};return{name:"@vuepress/plugin-shiki",extendsMarkdown:async(t,r)=>{const{code:n}=r.options.markdown;await le(t,r,{...x(n)?n:{},...e});const{preWrapper:i,lineNumbers:o,collapsedLines:l}=s;t.use(pe),t.use(ce,{preWrapper:i}),i&&(t.use(P,{lineNumbers:o}),t.use(T,{collapsedLines:l}))},clientConfigFile:t=>ge(t,s)}};export{L as bundledLanguageNames,we as bundledLanguages,A as default,A as shikiPlugin};
//# sourceMappingURL=index.js.map
